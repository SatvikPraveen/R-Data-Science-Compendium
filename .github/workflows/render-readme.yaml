# R Data Science Portfolio - README Rendering Workflow
# ====================================================
# Automatically render README.Rmd to README.md when changed

name: render-readme

on:
  push:
    branches: [main, develop]
    paths: ["README.Rmd"]
  pull_request:
    branches: [main, develop]
    paths: ["README.Rmd"]

jobs:
  render:
    runs-on: ubuntu-latest

    name: Render README

    env:
      GITHUB_PAT: ${{ secrets.GITHUB_TOKEN }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup R
        uses: r-lib/actions/setup-r@v2
        with:
          use-public-rspm: true

      - name: Setup Pandoc
        uses: r-lib/actions/setup-pandoc@v2

      - name: Setup R dependencies
        uses: r-lib/actions/setup-r-dependencies@v2
        with:
          extra-packages: |
            any::rmarkdown
            any::knitr
            any::devtools
          needs: check

      - name: System dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libcurl4-openssl-dev \
            libssl-dev \
            libxml2-dev \
            libharfbuzz-dev \
            libfribidi-dev \
            libfreetype6-dev \
            libpng-dev \
            libtiff5-dev \
            libjpeg-dev

      - name: Render README
        run: |
          if (file.exists("README.Rmd")) {
            cat("Rendering README.Rmd to README.md\n")
            
            # Set up environment for rendering
            options(repos = c(CRAN = "https://cran.rstudio.com"))
            
            # Render the README
            rmarkdown::render(
              "README.Rmd",
              output_format = rmarkdown::github_document(
                toc = TRUE,
                toc_depth = 3,
                html_preview = FALSE
              ),
              output_file = "README.md",
              quiet = FALSE
            )
            
            cat("README rendered successfully!\n")
          } else {
            cat("No README.Rmd found, skipping render.\n")
          }
        shell: Rscript {0}

      - name: Commit and push changes
        if: github.event_name == 'push'
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"

          if [[ `git status --porcelain` ]]; then
            git add README.md
            git add man/figures/README-*
            git commit -m "Re-build README.md" || exit 0
            git push || exit 0
          else
            echo "No changes to commit"
          fi

      - name: Check for changes (PR)
        if: github.event_name == 'pull_request'
        run: |
          if [[ `git status --porcelain` ]]; then
            echo "README.md is not up to date with README.Rmd"
            echo "Please run rmarkdown::render('README.Rmd') locally and commit the changes"
            git diff
            exit 1
          else
            echo "README.md is up to date with README.Rmd âœ“"
          fi
